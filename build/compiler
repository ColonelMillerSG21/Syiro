#!/bin/bash

currentDirectory=$(pwd) # Get the current directory
currentDirectory=${currentDirectory%build*} #Remove the build folder, if it exists, from the directory path

cd "$currentDirectory"

anyFilesChanged=false # Global anyFilesChanged tracks if any files are changed. If so we recompiling a devel.tar.gz.
declare -a filesThatHaveChanged # Create an array to hold the names of the files that have changed

fileChanged(){ # Function that checks if a file is new or has been changed
	sourceLocation=$1
	fileFullPath=$2

	mkdir -p build/sha1sums/"$sourceLocation" # Make the type specific sha1sums folder if it doesn't exist already

	file=${fileFullPath#*/} # Set file to be the name of the file without the path
	fileShaSumPath="build/sha1sums/$sourceLocation/$file" # Set the full patch of the potential sha1sum of the file

	latestFileSum=$(cat "src/$sourceLocation/$fileFullPath" | sha1sum) # Get the sha1sum of the file
	latestFileSum=${latestFileSum% -} # Remove everything after  -, which is sha1sum's reference to the file that was hashed
	latestFileSum=${latestFileSum:0:-1} # Remove the whitespace from the ending of the sha1sum

	FILE_CHANGED=""

	if [ -f "$fileShaSumPath" ]; then # If the sha1sum file of file exists
		currentRecordedSumOfFile=$(cat "$fileShaSumPath") # Get the sha1sum of the file stored

		if [ "$latestFileSum" != "$currentRecordedSumOfFile" ]; then # If the sums don't match (file diff)
			FILE_CHANGED="CHANGED"
		else
			FILE_CHANGED="NOT_CHANGED"
		fi
	else # If the sha1sum of the file does not exist
		FILE_CHANGED="CHANGED" # Assume the file has been changed, since there is no sum and it could be a new file
	fi

	if [ $FILE_CHANGED == "CHANGED" ]; then # If the file has been changed or is new, create an sha1sum of the file
		echo "$latestFileSum" > "$fileShaSumPath" # Write the contents
	fi

	return
}

recursiveCompiling(){ # Recursive function for code compiling
	sourceLocation=$1 # Set sourceLocation as the second location

	if [ "$sourceLocation" == "typescript" ]; then # If the sourceLocation is typescript code
		fileType="ts" # Set the fileType to ts
	else
		fileType="less" # Set the fileType to less
	fi

	filesArray=$(find src/"$sourceLocation"/ -type f -name "*.$fileType") # Get all files relating to this type recursively

	codebaseChanged=false # Set codebaseChanged to false by default. If a module has been added or changed, then it will be changed to true

	for file in $filesArray; do
		if [[ "$file" != *.d.ts ]]; then # If it is not a declaration file (exists after using the compiler once)
			fileName="${file##*$sourceLocation/}" # Remove everything before last / to clean up the file pathing
			fileChanged "$sourceLocation" "$fileName"

			if [ "$FILE_CHANGED" == "CHANGED" ]; then # If the file has been changed
				codebaseChanged=true # Change to true
				filesThatHaveChanged+=("$fileName")
			fi
		fi
	done

	if [ $codebaseChanged == true ]; then # If the codebase has been changed
		anyFilesChanged=true # Set Any Files Changed to true since the codebase has changed

		if [ "$sourceLocation" == "less" ]; then # If we are compiling the LESS
			# Run the Syiro LESS through the LESS compiler quietly, with no IE compatibility requirements and JS stuff
			/home/$USER/node_modules/less/bin/lessc --no-js --no-color --no-ie-compat --clean-css src/less/syiro.less build/syiro.css
			cp build/syiro.css tests/design/css/ # Copy newly built syiro.css to our tests
		else # If we are compiling Typescript
			anyFilesChanged=true # Set global var to true

			/home/$USER/node_modules/typescript/bin/tsc --removeComments --target 'ES5' src/typescript/syiro.ts --declaration --out build/syiro.js
			cp build/syiro.js tests/design/js/ # Copy syiro.js to tests/design/js

			echo "Minifying Syiro compiled Javascript."
			/home/$USER/node_modules/uglify-js/bin/uglifyjs build/syiro.js --output build/syiro.min.js --mangle --screw-ie8 --compress sequences,conditionals,comparisons,evaluate,booleans,loops,join_vars,hoist_funs,if_return,drop_console,properties,unsafe &> /dev/null

			zopfli build/syiro.min.js # Use zopfli to gzip content
			cp build/syiro.min.js tests/design/js/ # Copy the syiro.min.js to the tests/design/js

			echo "Finished compiling and minification process of Syiro."
		fi
	fi
}

echo "Compiling Syiro."

recursiveCompiling "less" # Compile LESS
recursiveCompiling "typescript" # Compile Typescript

if [ $anyFilesChanged == true ]; then # If the codebase has been changed
	echo "Files that have changed:"

	for file in ${filesThatHaveChanged[@]}
	do
		echo "$file"
	done
else # If the codebase has changed
	echo "No files have changed."
fi
